version: 1.0.0.{build}
image: Visual Studio 2019
pull_requests:
  do_not_increment_build_number: true
clone_depth: 1
environment:
  VCPKG_DIR: C:\Tools\vcpkg
  MY_BOOST_ROOT: C:\projects\boost
  MY_BOOST_INCLUDEDIR: C:\projects\boost
  MY_BOOST_LIBRARYDIR: C:\projects\boost\stage\lib
  MY_Qt6Widgets_DIR: C:\Qt\6.0.1\msvc2019_64\lib\cmake\Qt5Widgets
  QT_PATH: C:\Qt\6.0.1\msvc2019_64

init:
- ps: Set-WinSystemLocale ru-RU
- ps: Start-Sleep -s 5
- ps: Restart-Computer
cache:
  - C:\Tools\vcpkg\installed
install:
- call "C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Auxiliary\Build\vcvars64.bat"
- cd %VCPKG_DIR%
- git pull
- call .\bootstrap-vcpkg.bat
- .\vcpkg --triplet x64-windows install boost-filesystem
  boost-system boost-regex boost-random
  boost-uuid boost-crc zlib
  vulkan
- cd %APPVEYOR_BUILD_FOLDER%
build_script:
- cmd: >-
    mkdir tool1cd

    cd tool1cd

    cmake -DCMAKE_BUILD_TYPE=Release
    -DVCPKG_TARGET_ARCHITECTURE=x64
    -DCMAKE_PREFIX_PATH=%QT_PATH%
    -DCMAKE_TOOLCHAIN_FILE=%VCPKG_DIR%/scripts/buildsystems/vcpkg.cmake
    -DQt6Widgets_DIR="%MY_Qt6Widgets_DIR%"
    ..

    cmake --build . --target ctool1cd --config Release

    cmake --build . --target testproject --config Release

    cmake --build . --target gtool1cd --config Release

    cd ..

test_script:
- tool1cd\bin\Release\testproject.exe --reporter junit --out junit.xml

on_finish:
- ps: >-
    $wc = New-Object 'System.Net.WebClient'

    $wc.UploadFile("https://ci.appveyor.com/api/testresults/junit/$($env:APPVEYOR_JOB_ID)", (Resolve-Path .\junit.xml))

after_build:
- cmd: >-
    xcopy COPYING tool1cd\bin\Release

    7z a -r tool1cd-%APPVEYOR_BUILD_VERSION%.zip tool1cd\bin\Release

artifacts:
- path: tool1cd\bin\Release\ctool1cd.exe
  name: ctool1cd.exe
- path: tool1cd-*.zip
  name: tool1cd.zip
deploy: false
